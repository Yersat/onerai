{% extends 'base/base.html' %} {% load static %} {% load store_tags %} {% block title %}{{ product.name }}{% endblock %} {% block content %}
<!-- Product detail header -->
<section class="py-4 bg-dark">
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{% url 'store:index' %}">Главная</a></li>
        <li class="breadcrumb-item"><a href="{% url 'store:products' %}">Товары</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
      </ol>
    </nav>
  </div>
</section>

<!-- Product detail -->
<section class="py-5">
  <div class="container">
    <div class="row g-5">
      <!-- Product preview with t-shirt mockup -->
      <div class="col-lg-6">
        <div class="product-preview-container">
          {% if product.rendered_image %}
            <!-- Show the rendered t-shirt with design applied -->
            <img src="{{ product.rendered_image.url }}" alt="{{ product.name }}" class="img-fluid" id="rendered-preview">
          {% else %}
            <!-- Fallback to dynamic design placement if no rendered image -->
            <div class="tshirt-container">
              <img src="{% static 'img/tshirt-mockups/tshirt-black.png' %}" alt="T-shirt" class="tshirt-img" id="tshirt-preview">
              <div class="design-display">
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="design-image" id="design-image">
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Product info -->
      <div class="col-lg-6">
        <h1 class="h2 fw-bold mb-3">{{ product.name }}</h1>

        <div class="d-flex align-items-center mb-4">
          <div class="me-3">
            <span class="h3 fw-bold text-primary mb-0">{{ product.price }} ₸</span>
          </div>
          <div class="badge bg-success">В наличии</div>
        </div>

        <div class="mb-4">
          <h5 class="mb-3">Описание</h5>
          <p>{{ product.description }}</p>
        </div>

        {% if product.tags %}
        <div class="mb-4">
          <h5 class="mb-3">Ключевые слова</h5>
          <div class="d-flex flex-wrap gap-2">
            {% for tag in product.tags|split_tags %}
            <span class="badge bg-light text-dark">#{{ tag }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <div class="mb-4">
          <h5 class="mb-3">Доступные цвета</h5>
          <div class="d-flex flex-wrap gap-2">
            {% for color in product.available_colors|split_tags %}
              {% if color == "black" %}
                <div class="color-option color-black {% if forloop.first %}selected{% endif %}" data-color="black" title="Black"></div>
              {% elif color == "white" %}
                <div class="color-option color-white {% if forloop.first %}selected{% endif %}" data-color="white" title="White"></div>
              {% elif color == "red" %}
                <div class="color-option color-red {% if forloop.first %}selected{% endif %}" data-color="red" title="Red"></div>
              {% elif color == "blue" %}
                <div class="color-option color-blue {% if forloop.first %}selected{% endif %}" data-color="blue" title="Blue"></div>
              {% elif color == "yellow" %}
                <div class="color-option color-yellow {% if forloop.first %}selected{% endif %}" data-color="yellow" title="Yellow"></div>
              {% elif color == "green" %}
                <div class="color-option color-green {% if forloop.first %}selected{% endif %}" data-color="green" title="Green"></div>
              {% elif color == "grey" %}
                <div class="color-option color-grey {% if forloop.first %}selected{% endif %}" data-color="grey" title="Grey"></div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <div class="mb-4">
          <h5 class="mb-3">Размер</h5>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-primary">S</button>
            <button class="btn btn-outline-primary">M</button>
            <button class="btn btn-outline-primary">L</button>
            <button class="btn btn-outline-primary">XL</button>
            <button class="btn btn-outline-primary">XXL</button>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-3 mb-4">
          <button class="btn btn-primary btn-lg">
            <i class="fas fa-shopping-cart me-2"></i>В корзину
          </button>
          <button class="btn btn-outline-primary btn-lg">
            <i class="fas fa-heart me-2"></i>В избранное
          </button>
        </div>

        <div class="d-flex align-items-center">
          <img src="{% if product.creator.profile_image %}{{ product.creator.profile_image.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}" alt="{{ product.creator.username }}" class="rounded-circle me-2" width="40" height="40">
          <div>
            <p class="mb-0">Дизайн от <a href="{% url 'store:creator_profile' product.creator.username %}" class="fw-bold">{{ product.creator.username }}</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Related products -->
<section class="py-5 bg-light">
  <div class="container">
    <h2 class="h3 fw-bold mb-4">Похожие товары</h2>
    <div class="row g-4">
      <!-- This would be populated with actual related products -->
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card h-100">
          <div class="card-img-top-container">
            <img src="{% static 'img/placeholder.png' %}" class="card-img-top" alt="Product">
          </div>
          <div class="card-body">
            <h5 class="card-title">Название товара</h5>
            <p class="price mb-3">5990 ₸</p>
            <a href="#" class="btn btn-outline-primary w-100">Подробнее</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // T-shirt images for different colors
    const tshirtImages = {
      black: "{% static 'img/tshirt-mockups/tshirt-black.png' %}",
      white: "{% static 'img/tshirt-mockups/tshirt-white.png' %}",
      red: "{% static 'img/tshirt-mockups/tshirt-red.png' %}",
      blue: "{% static 'img/tshirt-mockups/tshirt-blue.png' %}",
      yellow: "{% static 'img/tshirt-mockups/tshirt-yellow.png' %}",
      green: "{% static 'img/tshirt-mockups/tshirt-green.png' %}",
      grey: "{% static 'img/tshirt-mockups/tshirt-grey.png' %}"
    };

    const colorOptions = document.querySelectorAll(".color-option");
    const productPreviewContainer = document.querySelector(".product-preview-container");

    // Initial state check
    const hasRenderedImage = document.getElementById("rendered-preview") !== null;
    let currentMode = hasRenderedImage ? "rendered" : "dynamic";

    // If we start with dynamic mode, get references to the elements
    let tshirtPreview = document.getElementById("tshirt-preview");
    let designImage = document.getElementById("design-image");

    // Function to switch from rendered image to dynamic design
    function switchToTshirtWithDesign(color) {
      // Clear the preview container
      productPreviewContainer.innerHTML = '';

      // Create the tshirt container
      const tshirtContainer = document.createElement("div");
      tshirtContainer.className = "tshirt-container";

      // Create the t-shirt image
      tshirtPreview = document.createElement("img");
      tshirtPreview.id = "tshirt-preview";
      tshirtPreview.src = tshirtImages[color];
      tshirtPreview.alt = "T-shirt";
      tshirtPreview.className = "tshirt-img";

      // Create the design container
      const designContainer = document.createElement("div");
      designContainer.className = "design-display";

      // Create the design image
      designImage = document.createElement("img");
      designImage.id = "design-image";
      designImage.src = "{{ product.image.url }}";
      designImage.alt = "{{ product.name }}";
      designImage.className = "design-image";

      // Apply appropriate filter based on t-shirt color
      applyDesignFilter(designImage, color);

      // Assemble the elements
      designContainer.appendChild(designImage);
      tshirtContainer.appendChild(tshirtPreview);
      tshirtContainer.appendChild(designContainer);
      productPreviewContainer.appendChild(tshirtContainer);

      // Update the mode
      currentMode = "dynamic";
    }

    // Function to apply the appropriate filter to the design based on t-shirt color
    function applyDesignFilter(designElement, color) {
      if (color === 'black' || color === 'blue' || color === 'green') {
        // For dark t-shirts, add a subtle brightness to the design
        designElement.style.filter = 'brightness(1.2) drop-shadow(0 0 3px rgba(255, 255, 255, 0.3))';
      } else {
        // For light t-shirts, keep normal brightness
        designElement.style.filter = 'drop-shadow(0 0 2px rgba(0, 0, 0, 0.2))';
      }
    }

    // Set initial t-shirt color based on first selected color option
    const initialSelectedColor = document.querySelector(".color-option.selected");
    if (initialSelectedColor) {
      const initialColor = initialSelectedColor.getAttribute("data-color");

      // If we're in dynamic mode, set the initial color and filter
      if (currentMode === "dynamic" && tshirtPreview && designImage) {
        if (tshirtImages[initialColor]) {
          tshirtPreview.src = tshirtImages[initialColor];
        }
        applyDesignFilter(designImage, initialColor);
      }
    }

    // Color selection
    colorOptions.forEach(option => {
      option.addEventListener("click", function() {
        // Get selected color
        const color = this.getAttribute("data-color");

        // Update selected color indicator
        colorOptions.forEach(opt => opt.classList.remove("selected"));
        this.classList.add("selected");

        if (currentMode === "dynamic") {
          // We're already in dynamic mode, just update the t-shirt color
          if (tshirtImages[color] && tshirtPreview) {
            tshirtPreview.src = tshirtImages[color];
            applyDesignFilter(designImage, color);
          }
        } else {
          // We need to switch from rendered to dynamic
          switchToTshirtWithDesign(color);
        }
      });
    });
  });
</script>
{% endblock %}
