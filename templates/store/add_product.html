{% extends 'base/base.html' %} {% load static %} {% block title %}Дизайнер продукта{% endblock %} {% block content %}
<!-- Product designer header -->
<section class="py-4 bg-dark">
  <div class="container">
    <h1 class="h2 fw-bold mb-0">Дизайнер продукта</h1>
  </div>
</section>

<!-- Create product form -->
<section class="py-5">
  <div class="container">
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <form
              action="{% url 'store:add_product' %}"
              method="post"
              enctype="multipart/form-data"
              class="needs-validation"
              novalidate
            >
              {% csrf_token %}
              <div class="row g-4">
                <!-- Basic info -->
                <div class="col-12">
                  <h4 class="border-bottom pb-3 mb-4">Основная информация</h4>
                </div>

                <div class="col-md-6">
                  <label for="name" class="form-label"
                    >Название дизайна *</label
                  >
                  <input
                    type="text"
                    class="form-control form-control-lg"
                    id="name"
                    name="name"
                    placeholder="Например: Горы Казахстана"
                    required
                  />
                  <div class="invalid-feedback">
                    Пожалуйста, укажите название товара
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="category" class="form-label"
                    >Категория товара *</label
                  >
                  <select
                    class="form-select form-select-lg"
                    id="category"
                    name="category"
                    required
                  >
                    <option value="" selected disabled>
                      Выберите категорию
                    </option>
                    <option value="Футболки">Футболки</option>
                    <option value="Худи">Худи</option>
                    <option value="Кружки">Кружки</option>
                    <option value="Постеры">Постеры</option>
                    <option value="Аксессуары">Аксессуары</option>
                    <option value="Другое">Другое</option>
                  </select>
                  <div class="invalid-feedback">
                    Пожалуйста, выберите категорию
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="price" class="form-label">Цена (₸) *</label>
                  <div class="input-group">
                    <input
                      type="number"
                      class="form-control form-control-lg"
                      id="price"
                      name="price"
                      min="0"
                      step="0.01"
                      placeholder="Например: 5990"
                      required
                    />
                    <span class="input-group-text">₸</span>
                    <div class="invalid-feedback">
                      Пожалуйста, укажите цену товара
                    </div>
                  </div>
                  <div class="form-text">
                    Мы рекомендуем устанавливать цену от 5,000 до 15,000 ₸.
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="tags" class="form-label">Ключевые слова</label>
                  <input
                    type="text"
                    class="form-control form-control-lg"
                    id="tags"
                    name="tags"
                    placeholder="Например: футболка, дизайн, природа"
                  />
                  <div class="form-text">
                    Введите ключевые слова через запятую. Они помогут покупателям найти ваш товар.
                  </div>
                </div>

                <div class="col-12">
                  <label for="description" class="form-label">Описание *</label>
                  <textarea
                    class="form-control"
                    id="description"
                    name="description"
                    rows="5"
                    placeholder="Опишите ваш дизайн и особенности товара..."
                    required
                  ></textarea>
                  <div class="invalid-feedback">
                    Пожалуйста, добавьте описание товара
                  </div>
                  <div class="form-text">
                    Хорошее описание повышает вероятность покупки. Расскажите об
                    идее дизайна, материалах и для кого этот товар.
                  </div>
                </div>

                <!-- Product Designer and Image Upload -->
                <div class="col-12">
                  <h4 class="border-bottom pb-3 mb-4 mt-3">
                    Дизайн футболки
                  </h4>
                </div>

                <div class="col-12">
                  <div class="product-designer">
                    <!-- T-shirt preview with tabs -->
                    <div class="product-designer-tabs">
                      <button class="product-designer-tab active" id="tab-front">Front</button>
                      <button class="product-designer-tab" id="tab-back">Back</button>
                    </div>

                    <!-- Preview area -->
                    <div class="product-designer-preview">
                      <div class="tshirt-container">
                        <img src="{% static 'img/tshirt-mockups/tshirt-black.png' %}" alt="T-shirt" class="tshirt-img" id="tshirt-preview">
                        <div class="design-area" id="design-area">
                          <div class="design-placeholder" id="design-placeholder">
                            <p>Drag and drop<br>artwork here</p>
                            <i class="fas fa-cloud-upload-alt"></i>
                          </div>
                          <img src="" alt="Your design" class="design-image d-none" id="design-image">

                          <!-- Resize handles -->
                          <div class="resize-handle resize-handle-nw d-none" id="resize-nw"></div>
                          <div class="resize-handle resize-handle-ne d-none" id="resize-ne"></div>
                          <div class="resize-handle resize-handle-sw d-none" id="resize-sw"></div>
                          <div class="resize-handle resize-handle-se d-none" id="resize-se"></div>
                        </div>
                      </div>
                    </div>

                    <!-- Color selector section -->
                    <div class="color-selector-section">
                      <div class="color-selector-title">
                        Выберите цвет для предпросмотра
                        <i class="fas fa-info-circle" title="Выберите цвет для предпросмотра дизайна"></i>
                      </div>
                      <div class="color-selector">
                        <div class="color-option color-black selected" data-color="black" title="Black"></div>
                        <div class="color-option color-white" data-color="white" title="White"></div>
                        <div class="color-option color-red" data-color="red" title="Red"></div>
                        <div class="color-option color-blue" data-color="blue" title="Blue"></div>
                        <div class="color-option color-yellow" data-color="yellow" title="Yellow"></div>
                        <div class="color-option color-green" data-color="green" title="Green"></div>
                        <div class="color-option color-grey" data-color="grey" title="Grey"></div>
                      </div>
                    </div>

                    <!-- Available colors selection -->
                    <div class="color-selector-section">
                      <div class="color-selector-title">
                        Выберите доступные цвета для продажи
                        <i class="fas fa-info-circle" title="Нажмите на цвета, которые вы хотите сделать доступными для продажи"></i>
                      </div>
                      <div class="color-selector-help">
                        Нажмите на цвета, чтобы выбрать их для продажи (максимум 3 цвета). Некоторые дизайны могут не подходить для определенных цветов.
                      </div>
                      <div class="color-selector" id="available-colors">
                        <div class="color-option color-black approved" data-color="black" title="Black"></div>
                        <div class="color-option color-white approved" data-color="white" title="White"></div>
                        <div class="color-option color-red" data-color="red" title="Red"></div>
                        <div class="color-option color-blue" data-color="blue" title="Blue"></div>
                        <div class="color-option color-yellow" data-color="yellow" title="Yellow"></div>
                        <div class="color-option color-green" data-color="green" title="Green"></div>
                        <div class="color-option color-grey" data-color="grey" title="Grey"></div>
                      </div>
                      <!-- Hidden input to store selected colors -->
                      <input type="hidden" name="available_colors" id="available-colors-input" value="black,white">
                    </div>

                    <!-- Design controls (always visible) -->
                    <div class="design-controls" id="design-controls">
                      <button type="button" class="design-control-btn" id="reset-design">
                        <i class="fas fa-undo me-1"></i> Reset
                      </button>
                      <button type="button" class="design-control-btn" id="center-design">
                        <i class="fas fa-align-center me-1"></i> Center
                      </button>
                      <button type="button" class="design-control-btn" id="move-right">
                        <i class="fas fa-arrow-right me-1"></i> Move Right
                      </button>
                      <button type="button" class="design-control-btn" id="move-left">
                        <i class="fas fa-arrow-left me-1"></i> Move Left
                      </button>
                    </div>

                    <!-- Size slider (always visible) -->
                    <div class="mt-3" id="size-control">
                      <label for="design-size" class="form-label">Design size</label>
                      <input type="range" class="form-range design-size-slider" id="design-size" min="20" max="100" value="60">
                    </div>
                  </div>

                  <!-- Hidden file input for design upload -->
                  <div class="d-none">
                    <input
                      type="file"
                      class="form-control"
                      id="image"
                      name="image"
                      accept="image/*"
                      required
                    />
                    <div class="invalid-feedback">
                      Пожалуйста, загрузите изображение дизайна
                    </div>
                  </div>

                  <!-- Requirements section -->
                  <div class="mt-4">
                    <h5 class="mb-3">Требования к изображению:</h5>
                    <ul class="list-unstyled">
                      <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Разрешение: минимум 1200x1200 пикс.
                      </li>
                      <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Формат: PNG или JPG (для прозрачного фона используйте PNG)
                      </li>
                      <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Размер файла: до 5 МБ
                      </li>
                      <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Четкое изображение без размытия и пикселизации
                      </li>
                      <li>
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Дизайн должен соответствовать правилам платформы
                      </li>
                    </ul>
                  </div>
                </div>

                <!-- Hidden fields for design position and size -->
                <input type="hidden" name="design_position" id="design-position-input" value="">

                <!-- Hidden canvas for rendering the final image -->
                <div class="d-none">
                  <canvas id="rendered-tshirt-canvas" width="800" height="800"></canvas>
                  <input type="hidden" name="rendered_image_data" id="rendered-image-data">
                  <div id="rendered-images-container">
                    <!-- Rendered images for each color will be added here dynamically -->
                  </div>
                </div>

                <!-- Submit section -->
                <div class="col-12 mt-4">
                  <div
                    class="d-flex flex-column flex-sm-row gap-3 justify-content-end"
                  >
                    <a
                      href="{% url 'store:index' %}"
                      class="btn btn-outline-secondary btn-lg"
                      >Отмена</a
                    >
                    <button type="submit" class="btn btn-primary btn-lg" id="submit-button">
                      <i class="fas fa-cloud-upload-alt me-2"></i>Отправить на проверку
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-primary text-white py-3">
            <h5 class="mb-0">
              <i class="fas fa-lightbulb me-2"></i>Как это работает
            </h5>
          </div>
          <div class="card-body p-4">
            <div class="d-flex mb-4">
              <div class="step-number me-3">
                <span
                  class="badge bg-primary rounded-circle d-flex align-items-center justify-content-center"
                  style="width: 30px; height: 30px"
                  >1</span
                >
              </div>
              <div>
                <h5>Создайте дизайн</h5>
                <p class="text-muted">
                  Загрузите свое изображение, добавьте описание и установите
                  цену.
                </p>
              </div>
            </div>
            <div class="d-flex mb-4">
              <div class="step-number me-3">
                <span
                  class="badge bg-primary rounded-circle d-flex align-items-center justify-content-center"
                  style="width: 30px; height: 30px"
                  >2</span
                >
              </div>
              <div>
                <h5>Мы печатаем при заказе</h5>
                <p class="text-muted">
                  Когда клиент делает заказ, мы производим и отправляем товар.
                </p>
              </div>
            </div>
            <div class="d-flex">
              <div class="step-number me-3">
                <span
                  class="badge bg-primary rounded-circle d-flex align-items-center justify-content-center"
                  style="width: 30px; height: 30px"
                  >3</span
                >
              </div>
              <div>
                <h5>Получите прибыль</h5>
                <p class="text-muted">
                  Вы получаете оплату за каждый проданный товар с вашим
                  дизайном.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="card border-0 shadow-sm">
          <div class="card-header bg-dark py-3">
            <h5 class="mb-0">
              <i class="fas fa-star me-2"></i>Советы для успешных продаж
            </h5>
          </div>
          <div class="card-body p-4">
            <ul class="list-group list-group-flush">
              <li class="list-group-item px-0 border-0">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong>Качественные изображения:</strong> Используйте четкие
                изображения с высоким разрешением
              </li>
              <li class="list-group-item px-0 border-0">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong>Детальное описание:</strong> Подробно опишите свой
                товар, включая все особенности
              </li>
              <li class="list-group-item px-0 border-0">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong>Целевая аудитория:</strong> Подумайте о том, кто будет
                покупать ваш дизайн
              </li>
              <li class="list-group-item px-0 border-0">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong>Оптимальная цена:</strong> Установите
                конкурентоспособную цену для вашей аудитории
              </li>
              <li class="list-group-item px-0 border-0">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong>Продвижение:</strong> Расскажите о своих товарах в
                социальных сетях
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Form validation
    const form = document.querySelector(".needs-validation");
    const designPositionInput = document.getElementById("design-position-input");

    // Function to render the t-shirt with design as a composite image for a specific color
    function renderTshirtWithDesign(color) {
      return new Promise((resolve, reject) => {
        try {
          const canvas = document.getElementById('rendered-tshirt-canvas');
          const ctx = canvas.getContext('2d');

          // Clear canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Create a new image for the t-shirt
          const tshirtImg = new Image();
          tshirtImg.crossOrigin = "Anonymous";
          tshirtImg.src = tshirtImages[color]; // Use the specific color t-shirt

          tshirtImg.onload = function() {
            // Draw the t-shirt on the canvas
            ctx.drawImage(tshirtImg, 0, 0, canvas.width, canvas.height);

            // If there's a design, draw it on top of the t-shirt
            if (!designImage.classList.contains('d-none') && designImage.src) {
              const designImg = new Image();
              designImg.crossOrigin = "Anonymous";
              designImg.src = designImage.src;

              designImg.onload = function() {
                // Calculate design position and size relative to the canvas
                const tshirtRect = tshirtPreview.getBoundingClientRect();
                const designRect = designArea.getBoundingClientRect();

                // Calculate the position of the design on the canvas
                const designX = (designRect.left - tshirtRect.left) * (canvas.width / tshirtRect.width);
                const designY = (designRect.top - tshirtRect.top) * (canvas.height / tshirtRect.height);
                const designWidth = designRect.width * (canvas.width / tshirtRect.width);
                const designHeight = designRect.height * (canvas.height / tshirtRect.height);

                // Draw the design on the canvas
                ctx.drawImage(designImg, designX, designY, designWidth, designHeight);

                // Convert canvas to data URL with reduced quality JPEG instead of PNG
                const renderedImageData = canvas.toDataURL('image/jpeg', 0.7);

                // Return the rendered image data with color information
                resolve({
                  color: color,
                  imageData: renderedImageData
                });
              };

              designImg.onerror = function() {
                reject(new Error('Failed to load design image'));
              };
            } else {
              // No design, just return the t-shirt image with reduced quality JPEG
              const renderedImageData = canvas.toDataURL('image/jpeg', 0.7);
              resolve({
                color: color,
                imageData: renderedImageData
              });
            }
          };

          tshirtImg.onerror = function() {
            reject(new Error('Failed to load t-shirt image'));
          };
        } catch (error) {
          reject(error);
        }
      });
    }

    // Function to render all selected colors
    async function renderAllSelectedColors() {
      try {
        const selectedColors = getSelectedAvailableColors();
        if (selectedColors.length === 0) {
          alert('Пожалуйста, выберите хотя бы один цвет для продажи');
          return null;
        }

        // Create a hidden input for each color's rendered image
        const renderedImagesContainer = document.getElementById('rendered-images-container');
        renderedImagesContainer.innerHTML = ''; // Clear previous inputs

        // Set the current color as the default rendered image
        let defaultRenderedImage = null;

        // Render each color
        for (const color of selectedColors) {
          const result = await renderTshirtWithDesign(color);

          // Create a hidden input for this color's rendered image
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = `rendered_image_${color}`;
          input.value = result.imageData;
          renderedImagesContainer.appendChild(input);

          // If this is the current color, set it as the default rendered image
          if (color === currentColor) {
            defaultRenderedImage = result.imageData;
            document.getElementById('rendered-image-data').value = result.imageData;
          }
        }

        // If the current color isn't in the selected colors, use the first one as default
        if (!defaultRenderedImage && selectedColors.length > 0) {
          const result = await renderTshirtWithDesign(selectedColors[0]);
          document.getElementById('rendered-image-data').value = result.imageData;
        }

        return true;
      } catch (error) {
        console.error('Error rendering t-shirts:', error);
        return null;
      }
    }

    if (form) {
      form.addEventListener("submit", async function (event) {
        event.preventDefault();

        if (!form.checkValidity()) {
          event.stopPropagation();
          form.classList.add("was-validated");
          return;
        }

        // Save design position and size data
        if (designArea && designPositionInput) {
          const designData = {
            left: designArea.style.left,
            top: designArea.style.top,
            width: designArea.style.width,
            height: designArea.style.height,
            color: currentColor,
            view: currentView
          };

          designPositionInput.value = JSON.stringify(designData);
        }

        // Check if at least one color is selected for availability
        const selectedColors = getSelectedAvailableColors();
        if (selectedColors.length === 0) {
          event.stopPropagation();
          alert('Пожалуйста, выберите хотя бы один цвет для продажи');
          return;
        }

        // Format tags if needed (remove extra spaces, etc.)
        const tagsInput = document.getElementById("tags");
        if (tagsInput && tagsInput.value) {
          // Split by comma, trim whitespace, and rejoin
          const formattedTags = tagsInput.value
            .split(',')
            .map(tag => tag.trim())
            .filter(tag => tag.length > 0)
            .join(', ');
          tagsInput.value = formattedTags;
        }

        form.classList.add("was-validated");

        // Disable submit button to prevent multiple submissions
        const submitButton = document.getElementById('submit-button');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Обработка...';

        try {
          // Render all selected colors
          const result = await renderAllSelectedColors();

          if (result) {
            // Submit the form
            form.submit();
          } else {
            // Re-enable submit button
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i>Отправить на проверку';
          }
        } catch (error) {
          console.error('Error rendering t-shirts with designs:', error);
          alert('Произошла ошибка при обработке изображений. Пожалуйста, попробуйте еще раз.');

          // Re-enable submit button
          submitButton.disabled = false;
          submitButton.innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i>Отправить на проверку';
        }
      });
    }

    // File input
    const fileInput = document.getElementById("image");

    // Product designer elements
    const designArea = document.getElementById("design-area");
    const designImage = document.getElementById("design-image");
    const designPlaceholder = document.getElementById("design-placeholder");
    const tshirtPreview = document.getElementById("tshirt-preview");
    const colorOptions = document.querySelectorAll(".color-selector:not(#available-colors) .color-option");
    const availableColorOptions = document.querySelectorAll("#available-colors .color-option");
    const availableColorsInput = document.getElementById("available-colors-input");
    const tabFront = document.getElementById("tab-front");
    const tabBack = document.getElementById("tab-back");
    const designControls = document.getElementById("design-controls");
    const resetDesignBtn = document.getElementById("reset-design");
    const centerDesignBtn = document.getElementById("center-design");
    const sizeControl = document.getElementById("size-control");
    const designSizeSlider = document.getElementById("design-size");
    const resizeHandles = document.querySelectorAll(".resize-handle");
    const uploadDesignBtn = document.getElementById("upload-design-btn");

    // T-shirt images for different colors
    const tshirtImages = {
      black: "{% static 'img/tshirt-mockups/tshirt-black.png' %}",
      white: "{% static 'img/tshirt-mockups/tshirt-white.png' %}",
      red: "{% static 'img/tshirt-mockups/tshirt-red.png' %}",
      blue: "{% static 'img/tshirt-mockups/tshirt-blue.png' %}",
      yellow: "{% static 'img/tshirt-mockups/tshirt-yellow.png' %}",
      green: "{% static 'img/tshirt-mockups/tshirt-green.png' %}",
      grey: "{% static 'img/tshirt-mockups/tshirt-grey.png' %}"
    };

    // Current state
    let currentView = "front";
    let currentColor = "black";
    let isDragging = false;
    let isResizing = false;
    let currentResizeHandle = null;
    let startX, startY, startWidth, startHeight, startLeft, startTop;

    // Initialize design area position and size (square)
    let designAreaPosition = {
      width: 200,
      height: 200,
      left: 0,
      top: 0
    };

    // File upload handling
    if (fileInput && designArea) {
      // Handle file selection via input
      fileInput.addEventListener("change", function (e) {
        if (this.files && this.files[0]) {
          updateDesignPreview(this.files[0]);
        }
      });

      // Make design area a drop zone
      designArea.addEventListener("dragover", function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.style.borderColor = "#009688";
        this.style.borderWidth = "3px";
        document.querySelector('.design-placeholder').style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
      });

      designArea.addEventListener("dragleave", function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (currentColor === 'black' || currentColor === 'blue' || currentColor === 'green') {
          this.style.borderColor = "rgba(255, 255, 255, 0.7)";
          this.style.borderWidth = "2px";
          document.querySelector('.design-placeholder').style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
        } else {
          this.style.borderColor = "rgba(0, 0, 0, 0.5)";
          this.style.borderWidth = "2px";
          document.querySelector('.design-placeholder').style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
        }
      });

      designArea.addEventListener("drop", function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (currentColor === 'black' || currentColor === 'blue' || currentColor === 'green') {
          this.style.borderColor = "rgba(255, 255, 255, 0.7)";
          this.style.borderWidth = "2px";
        } else {
          this.style.borderColor = "rgba(0, 0, 0, 0.5)";
          this.style.borderWidth = "2px";
        }

        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          fileInput.files = e.dataTransfer.files;
          updateDesignPreview(e.dataTransfer.files[0]);
        }
      });

      // Make design placeholder clickable to trigger file input
      designPlaceholder.addEventListener("click", function() {
        fileInput.click();
      });

      // Update design preview
      function updateDesignPreview(file) {
        const reader = new FileReader();

        reader.onload = function (e) {
          const imageData = e.target.result;

          // Update design preview
          designImage.src = imageData;
          designImage.classList.remove("d-none");
          designPlaceholder.classList.add("d-none");
          designArea.classList.add("has-design");
          // Controls are already visible
          // designControls.classList.remove("d-none");
          // sizeControl.classList.remove("d-none");
          resizeHandles.forEach(handle => handle.classList.remove("d-none"));

          // Make design area square
          const parentRect = designArea.parentElement.getBoundingClientRect();
          // Use 30% of the container width for a better size
          const squareSize = Math.min(parentRect.width, parentRect.height) * 0.3;
          designArea.style.width = squareSize + "px";
          designArea.style.height = squareSize + "px";

          // Remove any transform that might be interfering with positioning
          designArea.style.transform = "none";

          // Position the design using our positioning function
          positionDesign();
        };

        reader.readAsDataURL(file);
      }
    }

    // Product designer functionality
    if (designArea && tshirtPreview) {
      // Tab switching
      tabFront.addEventListener("click", function() {
        currentView = "front";
        tabFront.classList.add("active");
        tabBack.classList.remove("active");
      });

      tabBack.addEventListener("click", function() {
        currentView = "back";
        tabBack.classList.add("active");
        tabFront.classList.remove("active");
      });

      // Function to get selected available colors
      function getSelectedAvailableColors() {
        const selectedColors = [];
        availableColorOptions.forEach(option => {
          if (option.classList.contains('approved')) {
            selectedColors.push(option.getAttribute('data-color'));
          }
        });
        // Limit to maximum 3 colors to prevent RequestDataTooBig error
        if (selectedColors.length > 3) {
          alert('Для предотвращения ошибок загрузки, пожалуйста, выберите не более 3 цветов.');
          return selectedColors.slice(0, 3);
        }
        return selectedColors;
      }

      // Function to update available colors input
      function updateAvailableColorsInput() {
        const selectedColors = getSelectedAvailableColors();
        availableColorsInput.value = selectedColors.join(',');
      }

      // Preview color selection
      colorOptions.forEach(option => {
        option.addEventListener("click", function() {
          const color = this.getAttribute("data-color");
          currentColor = color;

          // Update selected color
          colorOptions.forEach(opt => opt.classList.remove("selected"));
          this.classList.add("selected");

          // Update t-shirt image
          if (tshirtImages[color]) {
            tshirtPreview.src = tshirtImages[color];
          }

          // Update design area border color for better visibility
          if (color === 'black' || color === 'blue' || color === 'green') {
            designArea.style.border = '2px dashed rgba(255, 255, 255, 0.7)';
            if (!designArea.classList.contains('has-design')) {
              document.querySelectorAll('.design-placeholder p, .design-placeholder i').forEach(el => {
                el.style.color = 'rgba(255, 255, 255, 0.7)';
              });
              document.querySelector('.design-placeholder').style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
            }
          } else {
            designArea.style.border = '2px dashed rgba(0, 0, 0, 0.5)';
            if (!designArea.classList.contains('has-design')) {
              document.querySelectorAll('.design-placeholder p, .design-placeholder i').forEach(el => {
                el.style.color = 'rgba(0, 0, 0, 0.7)';
              });
              document.querySelector('.design-placeholder').style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
            }
          }
        });
      });

      // Available colors selection
      availableColorOptions.forEach(option => {
        option.addEventListener("click", function() {
          // If this option is already approved and being clicked to unapprove, always allow
          if (this.classList.contains('approved')) {
            this.classList.remove('approved');
            updateAvailableColorsInput();
            return;
          }

          // Check if we already have 3 colors selected
          const currentlySelected = document.querySelectorAll('#available-colors .color-option.approved');
          if (currentlySelected.length >= 3) {
            alert('Для предотвращения ошибок загрузки, пожалуйста, выберите не более 3 цветов.');
            return;
          }

          // Toggle approved class
          this.classList.add('approved');

          // Update hidden input with selected colors
          updateAvailableColorsInput();
        });
      });

      // Initialize available colors input
      updateAvailableColorsInput();

      // Make design area draggable
      designArea.addEventListener("mousedown", function(e) {
        if (e.target === designImage || e.target === designArea) {
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          startLeft = designArea.offsetLeft;
          startTop = designArea.offsetTop;
          e.preventDefault();
        }
      });

      // Resize functionality
      resizeHandles.forEach(handle => {
        handle.addEventListener("mousedown", function(e) {
          isResizing = true;
          currentResizeHandle = this.id;
          startX = e.clientX;
          startY = e.clientY;
          startWidth = designArea.offsetWidth;
          startHeight = designArea.offsetHeight;
          startLeft = designArea.offsetLeft;
          startTop = designArea.offsetTop;
          e.preventDefault();
          e.stopPropagation();
        });
      });

      // Mouse move handler for drag and resize
      document.addEventListener("mousemove", function(e) {
        if (isDragging) {
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;

          const newLeft = startLeft + dx;
          const newTop = startTop + dy;

          // Keep within bounds
          const parentRect = designArea.parentElement.getBoundingClientRect();
          const designRect = designArea.getBoundingClientRect();

          if (newLeft >= 0 && newLeft + designRect.width <= parentRect.width) {
            designArea.style.left = newLeft + "px";
          }

          if (newTop >= 0 && newTop + designRect.height <= parentRect.height) {
            designArea.style.top = newTop + "px";
          }
        } else if (isResizing) {
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;

          let newWidth = startWidth;
          let newHeight = startHeight;
          let newLeft = startLeft;
          let newTop = startTop;

          // Handle different resize handles and maintain square shape
          switch (currentResizeHandle) {
            case "resize-se":
              // Use the larger of dx or dy to maintain square
              const delta_se = Math.max(Math.abs(dx), Math.abs(dy)) * (dx > 0 ? 1 : -1);
              newWidth = startWidth + delta_se;
              newHeight = newWidth; // Keep square
              break;
            case "resize-sw":
              const delta_sw = Math.max(Math.abs(dx), Math.abs(dy)) * (dx > 0 ? 1 : -1);
              newWidth = startWidth - delta_sw;
              newHeight = newWidth; // Keep square
              newLeft = startLeft + delta_sw;
              break;
            case "resize-ne":
              const delta_ne = Math.max(Math.abs(dx), Math.abs(dy)) * (dx > 0 ? 1 : -1);
              newWidth = startWidth + delta_ne;
              newHeight = newWidth; // Keep square
              newTop = startTop + (startHeight - newHeight);
              break;
            case "resize-nw":
              const delta_nw = Math.max(Math.abs(dx), Math.abs(dy)) * (dx > 0 ? 1 : -1);
              newWidth = startWidth - delta_nw;
              newHeight = newWidth; // Keep square
              newLeft = startLeft + delta_nw;
              newTop = startTop + (startHeight - newHeight);
              break;
          }

          // Apply minimum size
          const minSize = 50;
          if (newWidth >= minSize && newHeight >= minSize) {
            designArea.style.width = newWidth + "px";
            designArea.style.height = newHeight + "px";
            designArea.style.left = newLeft + "px";
            designArea.style.top = newTop + "px";
          }
        }
      });

      // Mouse up handler to stop dragging/resizing
      document.addEventListener("mouseup", function() {
        isDragging = false;
        isResizing = false;
      });

      // Size slider
      designSizeSlider.addEventListener("input", function() {
        const size = this.value;
        const parentRect = designArea.parentElement.getBoundingClientRect();
        const newSize = (parentRect.width * size) / 100;

        // Make it square
        const newWidth = newSize;
        const newHeight = newSize;

        // Apply the new size
        designArea.style.width = newWidth + "px";
        designArea.style.height = newHeight + "px";

        // Use our positioning function to maintain the current horizontal position
        positionDesign();
      });

      // Reset design
      resetDesignBtn.addEventListener("click", function() {
        if (designImage.classList.contains("d-none")) {
          // If no design is uploaded, just reset size and position
          designSizeSlider.value = 60;
          currentHorizontalPosition = 0.5; // Reset to center
          const event = new Event("input");
          designSizeSlider.dispatchEvent(event);
        } else {
          // Clear the design
          fileInput.value = "";
          designImage.src = "";
          designImage.classList.add("d-none");
          designPlaceholder.classList.remove("d-none");
          designArea.classList.remove("has-design");
          // Don't hide controls anymore
          // designControls.classList.add("d-none");
          // sizeControl.classList.add("d-none");
          resizeHandles.forEach(handle => handle.classList.add("d-none"));

          // Reset size and position
          designSizeSlider.value = 60;
          currentHorizontalPosition = 0.5; // Reset to center
          const event = new Event("input");
          designSizeSlider.dispatchEvent(event);
        }
      });

      // Get move buttons
      const moveRightBtn = document.getElementById("move-right");
      const moveLeftBtn = document.getElementById("move-left");

      // Current horizontal position (0.5 is center)
      let currentHorizontalPosition = 0.5;

      // Center design
      centerDesignBtn.addEventListener("click", centerDesign);

      // Move right
      if (moveRightBtn) {
        moveRightBtn.addEventListener("click", function() {
          // Increase horizontal position (move right)
          currentHorizontalPosition += 0.05;
          if (currentHorizontalPosition > 0.8) currentHorizontalPosition = 0.8; // Limit
          positionDesign();
        });
      }

      // Move left
      if (moveLeftBtn) {
        moveLeftBtn.addEventListener("click", function() {
          // Decrease horizontal position (move left)
          currentHorizontalPosition -= 0.05;
          if (currentHorizontalPosition < 0.2) currentHorizontalPosition = 0.2; // Limit
          positionDesign();
        });
      }

      function centerDesign() {
        // Reset to center
        currentHorizontalPosition = 0.5;
        positionDesign();
      }

      function positionDesign() {
        const parentRect = designArea.parentElement.getBoundingClientRect();
        const designRect = designArea.getBoundingClientRect();

        // Position in the center of the t-shirt chest area
        // Horizontally positioned based on currentHorizontalPosition
        const newLeft = parentRect.width * currentHorizontalPosition - designRect.width / 2;

        // Vertically positioned - adjust this value to move up/down
        // Lower values move it higher on the shirt
        const verticalPosition = 0.35; // 0.35 is higher on the chest than 0.4
        const newTop = parentRect.height * verticalPosition - designRect.height / 2;

        // Apply the new position
        designArea.style.left = newLeft + "px";
        designArea.style.top = newTop + "px";

        console.log("Design area positioned at:", newLeft, newTop, "Horizontal position:", currentHorizontalPosition);
      }

      // Initialize design position and remove any transform that might be interfering
      designArea.style.transform = "none";

      // Set initial size (square)
      const parentRect = designArea.parentElement.getBoundingClientRect();
      const initialSize = Math.min(parentRect.width, parentRect.height) * 0.3;
      designArea.style.width = initialSize + "px";
      designArea.style.height = initialSize + "px";

      // Position the design using our positioning function
      positionDesign();

      // Set initial design area border for black t-shirt
      designArea.style.border = '2px dashed rgba(255, 255, 255, 0.7)';
      document.querySelectorAll('.design-placeholder p, .design-placeholder i').forEach(el => {
        el.style.color = 'rgba(255, 255, 255, 0.7)';
      });
      document.querySelector('.design-placeholder').style.backgroundColor = 'rgba(255, 255, 255, 0.3)';

      // Upload design button click handler
      if (uploadDesignBtn) {
        uploadDesignBtn.addEventListener("click", function() {
          fileInput.click();
        });
      }
    }
  });
</script>


{% endblock %}
